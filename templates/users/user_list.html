{% extends 'equipment/dashboard.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Lista de Usuarios Registrados</h2>
    <!-- Buscador y filtros en tiempo real -->
    <div class="row g-3 mb-3 align-items-end">
        <div class="col-md-4">
            <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nombre, cédula o usuario">
        </div>
        <div class="col-md-8">
            <div class="form-check form-check-inline">
                <input class="form-check-input rol-filter" type="checkbox" value="administrador" id="filtroAdministrador">
                <label class="form-check-label" for="filtroAdministrador">Administrador</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input rol-filter" type="checkbox" value="tecnico" id="filtroTecnico">
                <label class="form-check-label" for="filtroTecnico">Técnico</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input rol-filter" type="checkbox" value="usuario" id="filtroUsuario">
                <label class="form-check-label" for="filtroUsuario">Usuario</label>
            </div>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle" id="tablaUsuarios">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Nombre de Usuario</th>
                    <th>Nombre</th>
                    <th>Cédula</th>
                    <th>Teléfono</th>
                    <th>Cargo</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="usuariosTbody">
                {% for user in users %}
                <tr data-rol="{{ user.rol }}">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.get_full_name }}</td>
                    <td>{{ user.cedula }}</td>
                    <td>{{ user.telefono }}</td>
                    <td>{{ user.get_cargo_display }}</td>
                    <td>{{ user.get_rol_display }}</td>
                    <td>
                        {% if user.activo %}
                            <span class="badge bg-success">Activo</span>
                        {% else %}
                            <span class="badge bg-danger">Inactivo</span>
                        {% endif %}
                    </td>
                    <td>
                        <!-- Botón para abrir modal de detalles -->
                        <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#modalUsuario{{ user.id }}">Ver</button>
                        <a href="{% url 'users:user_edit' user.id %}" class="btn btn-warning btn-sm">Editar</a>
                        
                    </td>
                </tr>

                <!-- Modal de detalles del usuario -->
                <div class="modal fade" id="modalUsuario{{ user.id }}" tabindex="-1" aria-labelledby="modalUsuarioLabel{{ user.id }}" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="modalUsuarioLabel{{ user.id }}">Detalles de Usuario</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                      </div>
                      <div class="modal-body">
                        <p><strong>Nombre de usuario:</strong> {{ user.username }}</p>
                        <p><strong>Nombre:</strong> {{ user.get_full_name }}</p>
                        <p><strong>Cédula:</strong> {{ user.cedula }}</p>
                        <p><strong>Teléfono:</strong> {{ user.telefono }}</p>
                        <p><strong>Cargo:</strong> {{ user.get_cargo_display }}</p>
                        <p><strong>Rol:</strong> {{ user.get_rol_display }}</p>
                        <p><strong>Estado:</strong> {% if user.activo %}Activo{% else %}Inactivo{% endif %}</p>
                        <p><strong>Fecha de creación:</strong> {{ user.fecha_creacion|date:'d/m/Y H:i' }}</p>
                        <p><strong>Última actualización:</strong> {{ user.fecha_actualizacion|date:'d/m/Y H:i' }}</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <a href="{% url 'users:user_edit' user.id %}" class="btn btn-warning">Editar</a>
                        
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Búsqueda y filtrado en tiempo real usando JavaScript
// Filtra por texto y por rol (checkbox)
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const tbody = document.getElementById('usuariosTbody');
    const checkboxes = document.querySelectorAll('.rol-filter');

    function filtrarTabla() {
        const texto = searchInput.value.toLowerCase();
        const rolesSeleccionados = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
        const rows = tbody.getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            let text = rows[i].textContent.toLowerCase();
            let rol = rows[i].getAttribute('data-rol');
            let visiblePorTexto = text.includes(texto);
            let visiblePorRol = rolesSeleccionados.length === 0 || rolesSeleccionados.includes(rol);
            rows[i].style.display = (visiblePorTexto && visiblePorRol) ? '' : 'none';
        }
    }

    if (searchInput) {
        searchInput.addEventListener('keyup', filtrarTabla);
    }
    checkboxes.forEach(cb => cb.addEventListener('change', filtrarTabla));
});
</script>
{% endblock %}
